name: Build and Deploy (Astro + CNB)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Clean old build
        run: rm -rf ./dist

      - name: Build project
        run: npm run build

      - name: Deploy to GitHub Pages & CNB
        env:
          GH_ACTOR: ${{ github.actor }}
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CNB_USERNAME: ${{ secrets.CNB_USERNAME }}
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_HASH: ${{ github.sha }}
        run: |
          cd ./dist
          git init

          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          SHORT_HASH=$(echo "$COMMIT_HASH" | cut -c1-7)
          COMMIT_URL="https://github.com/${GH_REPO}/commit/${COMMIT_HASH}"

          # Áî® printf Ê≠£Á°ÆÁîüÊàêÂ§öË°å commit message
          MESSAGE=$(printf "Deploy from GitHub: \"%s\"\nSource commit: %s (%s)\nBuilt at: %s" \
            "$COMMIT_MESSAGE" "$SHORT_HASH" "$COMMIT_URL" "$BUILD_TIME")

          git add .
          git commit -m "$MESSAGE"

          echo "üöÄ Êé®ÈÄÅÂà∞ GitHub Pages ÂàÜÊîØ(page)"
          git push --force --quiet "https://${GH_ACTOR}:${GH_TOKEN}@github.com/${GH_REPO}.git" master:page

          echo "üåê ÂêåÊ≠•Âà∞ CNB ‰ªìÂ∫ì"
          git branch -M main
          git remote add origin "https://${CNB_USERNAME}:${CNB_TOKEN}@cnb.cool/Liiiu/Blog.git"
          git push --force --quiet origin main