---
title: é€šè¿‡Waline APIè·å–æœ€æ–°è¯„è®ºå¹¶æ˜¾ç¤º
description: åŸºäºwalineå®˜æ–¹æ–‡æ¡£æ¥å£çš„å°è¿ç”¨
publishDate: '2025-11-02'
heroImage:
  src: ./cover.jpg
  alt: an image targetting my article
tags:
  - ä¸»é¢˜é­”æ”¹
  - Waline
  - TypeScript
  - CSS
  - Astro
comment: true
language: ä¸­æ–‡
summary: >-
  æ–‡ç« ä»‹ç»äº†å¦‚ä½•é€šè¿‡Waline APIè·å–æœ€æ–°è¯„è®ºå¹¶æ˜¾ç¤ºåœ¨ç½‘ç«™ä¸­ã€‚é¦–å…ˆï¼Œæµè§ˆäº†Walineçš„å®˜æ–¹æ¥å£æ–‡æ¡£ï¼Œå‘ç°å¯ä»¥é€šè¿‡
  /api/comment?type=recent
  æ¥å£è·å–æœ€æ–°è¯„è®ºæ•°æ®ã€‚ç„¶åï¼Œç¼–å†™äº†ä¸€ä¸ªé€‚ç”¨äºå½“å‰ä¸»é¢˜çš„è¯„è®ºå±•ç¤ºç»„ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œå¼•å…¥äº†ä»£ç ç‰‡æ®µGistï¼Œå¹¶åœ¨src/pluginsç›®å½•ä¸‹æ–°å»ºäº†recentcomment.tsæ–‡ä»¶ï¼Œå¹¶åœ¨src/assets/stylesç›®å½•ä¸‹æ–°å»ºäº†rc.cssæ–‡ä»¶ã€‚æœ€åï¼Œåœ¨src/componentsç›®å½•ä¸‹æ–°å»ºäº†RecentComments.astroæ–‡ä»¶ï¼Œå¹¶åœ¨Pureä¸»é¢˜ä¸»é¡µä¸­ä½¿ç”¨äº†è¿™ä¸ªç»„ä»¶ã€‚
---

## èµ·å› 

æµè§ˆ [Walineçš„å®˜æ–¹æ¥å£æ–‡æ¡£](https://waline.js.org/reference/server/api.html) æ—¶å‘ç°é€šè¿‡ `/api/comment?type=recent` æ¥å£èƒ½è¿”å›ç½‘ç«™æœ€æ–°è¯„è®ºæ•°æ®ï¼Œäºæ˜¯â€œå¥´å½¹â€AIç»™æˆ‘å†™äº†ä¸€ä¸ªé€‚ç”¨å½“å‰ä¸»é¢˜çš„è¯„è®ºå±•ç¤ºç»„ä»¶ï¼Œç›®å‰æ²¡å‡ºå•¥å¤§å·®é”™ğŸ¤£

## å¼•å…¥

ä»£ç ç‰‡æ®µGistå¼€æºåœ°å€ï¼š[Recent Comments for Astro-Theme-Pure](https://gist.github.com/ljxme/e08c5d42abc5e5aa3fdda2d16aa5a60a)

### rc.cssæ–‡ä»¶

åœ¨ `src/assets/styles` ç›®å½•ä¸‹æ–°å»º `rc.css` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```css title="rc.css"
/* æœ€æ–°è¯„è®ºç»„ä»¶æ ·å¼ */
.recent-comments {
  background-color: hsl(var(--background) / var(--un-bg-opacity, 1));
  border: 1px solid hsl(var(--border) / var(--un-border-opacity, 1));
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1.5rem;
  margin-top: 0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.recent-comments-title {
  font-size: 1.2rem;
  font-weight: 500;
  margin-bottom: 1rem;
  color: hsl(var(--foreground) / var(--un-text-opacity, 1));
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.recent-comments-title svg {
  width: 1.2rem;
  height: 1.2rem;
}

.comment-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  display: flex;
  gap: 0.75rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid hsl(var(--border) / 0.5);
}

.comment-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.comment-avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
}

.comment-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.comment-content {
  flex: 1;
  min-width: 0;
}

.comment-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.25rem;
}

.comment-author {
  font-weight: 500;
  color: hsl(var(--foreground) / var(--un-text-opacity, 1));
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.comment-time {
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
}

.comment-text {
  font-size: 0.9rem;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  word-break: break-word;
}

.comment-link {
  display: block;
  font-size: 0.8rem;
  color: hsl(var(--primary) / var(--un-text-opacity, 1));
  margin-top: 0.25rem;
  text-decoration: none;
  transition: opacity 0.2s;
}

.comment-link:hover {
  opacity: 0.8;
}

.comment-empty {
  text-align: center;
  padding: 1rem 0;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
  font-size: 0.9rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .comment-avatar {
    width: 2rem;
    height: 2rem;
  }

  .comment-author {
    font-size: 0.85rem;
  }

  .comment-time {
    font-size: 0.75rem;
  }

  .comment-text {
    font-size: 0.85rem;
    -webkit-line-clamp: 2;
  }
}
```

### RecentComments.astroæ–‡ä»¶

3. åœ¨ç›®å½•ä¸‹ `src/components` ç›®å½•ä¸‹æ–°å»º `RecentComments.astro` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```astro title="RecentComments.astro"
---
import { Icon } from 'astro-pure/user'
import config from '@/site-config'

const limit = 5
const refreshMs = 60_000
---

<div class='recent-comments' data-recent-comments data-limit={limit} data-refresh-ms={refreshMs}>
  <div class='recent-comments-title'>
    <Icon name='list' class='me-2' color='#A6923F' />
    <span>æœ€æ–°è¯„è®º</span>
  </div>

  <div class='comment-list'>
    <div class='comment-empty'>åŠ è½½ä¸­...</div>
  </div>
</div>

<script
  is:inline
  type='module'
  data-astro-rerun
  define:vars={{
    walineServer: config.integ.waline.server,
    defaultLimit: limit,
    defaultRefreshMs: refreshMs
  }}
>

  const normalizeServer = (server) => String(server || '').replace(/\/$/, '')

  const formatCommentTime = (timestamp) => {
    const date = new Date(timestamp)
    const diff = Date.now() - date.getTime()

    if (diff < 60 * 1000) return 'åˆšåˆš'
    if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}åˆ†é’Ÿå‰`
    if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}å°æ—¶å‰`
    if (diff < 7 * 24 * 60 * 60 * 1000) return `${Math.floor(diff / (24 * 60 * 60 * 1000))}å¤©å‰`

    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
  }

  const stripHtml = (html) => {
    const doc = new DOMParser().parseFromString(String(html || ''), 'text/html')
    return doc.body.textContent || ''
  }

  const truncateText = (text, length = 100) => {
    const s = String(text || '')
    if (s.length <= length) return s
    return s.slice(0, length) + '...'
  }

  const normalizeUrl = (url) => {
    const s = String(url || '')
    if (!s) return '#'
    return s.endsWith('/') ? s.slice(0, -1) : s
  }

  const buildKey = (items) =>
    items.map((c) => `${c.nick ?? ''}|${c.time ?? ''}|${c.url ?? ''}|${c.avatar ?? ''}`).join('||')

  const renderComments = (root, comments) => {
    const listEl = root.querySelector('.comment-list')
    if (!listEl) return

    listEl.replaceChildren()

    if (!comments.length) {
      const empty = document.createElement('div')
      empty.className = 'comment-empty'
      empty.textContent = 'æš‚æ— è¯„è®ºæ•°æ®'
      listEl.appendChild(empty)
      return
    }

    const frag = document.createDocumentFragment()

    for (const comment of comments) {
      const item = document.createElement('div')
      item.className = 'comment-item'

      const avatarWrap = document.createElement('div')
      avatarWrap.className = 'comment-avatar'

      const img = document.createElement('img')
      img.src = comment.avatar || ''
      img.alt = comment.nick || ''
      img.loading = 'lazy'
      avatarWrap.appendChild(img)

      const content = document.createElement('div')
      content.className = 'comment-content'

      const meta = document.createElement('div')
      meta.className = 'comment-meta'

      const author = document.createElement('span')
      author.className = 'comment-author'
      author.textContent = comment.nick || ''

      const time = document.createElement('span')
      time.className = 'comment-time'
      time.dataset.time = String(comment.time || '')
      time.textContent = comment.time ? formatCommentTime(comment.time) : ''

      meta.append(author, time)

      const text = document.createElement('a')
      text.className = 'comment-text'
      text.textContent = truncateText(stripHtml(comment.comment), 100)
      text.href = normalizeUrl(comment.url) + (comment.objectId ? `#${comment.objectId}` : '')

      content.append(meta, text)
      item.append(avatarWrap, content)

      frag.appendChild(item)
    }

    listEl.appendChild(frag)
  }

  const updateTimesOnly = (root) => {
    const timeEls = root.querySelectorAll('.comment-time[data-time]')
    timeEls.forEach((el) => {
      const timestamp = Number(el.dataset.time)
      if (!Number.isFinite(timestamp) || timestamp <= 0) return
      el.textContent = formatCommentTime(timestamp)
    })
  }

  const fetchRecentComments = async (server, signal) => {
    const base = normalizeServer(server)
    if (!base) return []

    const res = await fetch(`${base}/api/comment?type=recent`, { signal })
    if (!res.ok) return []

    const json = await res.json()
    const data = Array.isArray(json?.data) ? json.data : []
    return data
  }

  const initRecentComments = (root) => {
    const limit = Number(root.dataset.limit || defaultLimit) || defaultLimit
    const refreshMs = Number(root.dataset.refreshMs || defaultRefreshMs) || defaultRefreshMs

    let lastKey = ''
    const aborter = new AbortController()

    const tick = async () => {
      try {
        const list = await fetchRecentComments(walineServer, aborter.signal)
        const items = list.slice(0, limit)
        const key = items.length ? buildKey(items) : '__EMPTY__'

        if (key !== lastKey) {
          lastKey = key
          renderComments(root, items)
        } else {
          updateTimesOnly(root)
        }
      } catch (e) {
        if (e?.name === 'AbortError') return
        console.error('Recent comments error:', e)
        const listEl = root.querySelector('.comment-list')
        if (listEl) {
          listEl.innerHTML = `<div class="comment-empty error">åŠ è½½å¤±è´¥:${e.message}</div>`
        }
      }
    }

    tick()

    const timer = window.setInterval(() => {
      if (document.hidden) return
      tick()
    }, refreshMs)

    const onVisible = () => {
      if (!document.hidden) tick()
    }
    document.addEventListener('visibilitychange', onVisible)

    return () => {
      aborter.abort()
      window.clearInterval(timer)
      document.removeEventListener('visibilitychange', onVisible)
    }
  }

  const disposers = new Set()

  const boot = () => {
    document.querySelectorAll('[data-recent-comments]').forEach((root) => {
      if (root.__recentCommentsInited) return
      root.__recentCommentsInited = true
      disposers.add(initRecentComments(root))
    })
  }

  const disposeAll = () => {
    disposers.forEach((fn) => fn())
    disposers.clear()
  }

  const start = () => boot()

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, { once: true })
  } else {
    start()
  }

  document.addEventListener('astro:page-load', boot)
  document.addEventListener('astro:before-swap', disposeAll)
</script>

<style is:global>
  @import '@/assets/styles/rc.css';
</style>

```

## ä½¿ç”¨

### åœ¨Pureä¸»é¢˜ä¸»é¡µä¸­ä½¿ç”¨

å¢æ·» `src/pages/index.astro` æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```astro title="index.astro"
---
import RecentComments from '@/components/RecentComments.astro' //å¼•å…¥ç»„ä»¶ [!code ++]
---

<PageLayout meta={{ title: 'é¦–é¡µ' }} highlightColor='#FFF8DC'>
  <main class='flex w-full flex-col items-center'>
    <div
      id='content'
      class='animate flex flex-col md:flex-row gap-y-10 md:gap-x-6 md:w-4/5 lg:w-5/6'
    >
      <!-- çœç•¥ä¸­é—´ä»£ç  -->
      <div class='md:w-1/3 md:mt-0'> <!-- [!code ++] -->
        <RecentComments /> <!-- [!code ++] -->
      </div> <!-- [!code ++] -->
      <!-- çœç•¥æ­¤åä»£ç  -->
    </div>
    <Quote class='mt-12' />
  </main>
</PageLayout>
```

### æœ€å°åŒ–ä½¿ç”¨

```astro
---
import RecentComments from '@/components/RecentComments.astro'
---

<RecentComments />
```
